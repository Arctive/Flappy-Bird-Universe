<html>
    <head>
        <title>Blocky Bird!</title>
        <style>
            button:hover{
                background-color: #2b9AAd;
                color: white;
            }
            canvas{
                border: 2px solid #666666;
            }
        </style>
    </head>
    <body>
        <center>
            <h1>Blocky Bird</h1>
            <button id = "start" onclick="startGame();">Start Game!</button>
            <canvas id="grid" width="480" height="480"></canvas>
        </center>
        <script>
            //alert("Hello World *dabs*");
            // Setup game graphic objects
            var c = document.getElementById("grid");
            var ctx = c.getContext('2d');
            var player = {"x":50, "y":0, "size":10, "v":0};
            var gapConst = player.size * 10;
            var pipeWidth = 25;
            var obstacles = [];
            var gameUpdate;
            var pipeUpdate;
            var score = 0;
            //c.style.backgroundColor = "lightcyan";
            c.style.display = "none"; //Makes Game Map invisible

            function startGame(){
                player.x = 50;
                player.y = 0;
                player.size = 10;
                player.v = 0;
                obstacles = [0];
                score = 0;
                window.addEventListener('keypress',keyHandler);
                gameUpdate = setInterval(update, 8);
                pipeUpdate = setInterval(spawnPipe, 2800);
                c.style.display = "block";
                var s = document.getElementById("start");
                s.style.display = "none";
                //drawPlayer();
            }
            //Update the game frame
            function update(){
                ctx.clearRect(0,0, c.width, c.height);
                gravity();
                if (drawPipes())
                    endGame();
            }

            function gravity(){
                //player.v += 0.0098;
                player.v += 0.02;
                player.y = Math.min(c.height - 10, Math.max(0, player.y + player.v));
            }

            function spawnPipe(){
                //obstacles.push({ "hole": Math.floor(Math.random() * 0.7 * c.height + 0.2 * c.height),"x": c.width});
                obstacles.push({ "hole": Math.floor(Math.random() * (c.height - 2 * gapConst) + 0.5*gapConst),"x": c.width});
            }

            function drawPlayer(){
                //ctx.fillStyle = "#ffff1a";
                ctx.fillRect(player.x, player.y, player.size, player.size);
                ctx.strokeStyle = "#000000";
                ctx.strokeRect(player.x, player.y, player.size, player.size);
            }

            function drawPipes(){
                for(i = 0; i < obstacles.length; i++){
                    var crash = false;
                    obstacles[i].x -= 1;
                    //ctx.fillStyle = "#00b359";
                    ctx.fillRect(obstacles[i].x, 0, pipeWidth, c.height);
                    ctx.clearRect(obstacles[i].x, obstacles[i].hole, pipeWidth, gapConst);
                    //top pipe ends at (obstacles[i].y + obstacles[i].hole)
                    //bottom pipe starts at (obstacles[i].y + obstacles[i].hole + 100)
                    if( (player.x + player.size == obstacles[i].x && (player.y <= obstacles[i].hole || player.y + player.size >= obstacles[i].hole + 100)) 
                        || ((player.x >= obstacles[i].x && player.x + player.size <= obstacles[i].x + 20) && 
                            (player.y <= obstacles[i].hole || player.y + player.size >= obstacles[i].hole + 100))
                        || (player.y + player.size >= c.height)){
                        crash = true;
                        break;
                    } 
                    if (obstacles[i].x == player.x)
                        score++; //update score
                    }
                //show score
                ctx.fillStyle = "#000";
                ctx.font = "20px Verdana";
                ctx.fillText("Score : "+score, 10, 20);
                drawPlayer();
                return crash;
            }

            function keyHandler(e){
                ctx.clearRect(player.x,player.y,player.size,player.size);
                var code = e.keyCode;
                if(code == 32) //space key, make bird fly/jump
                    player.v = -1.3;
                if(code == 114){ // 'r' key, restart the game
                    clearInterval(gameUpdate);
                    clearInterval(pipeUpdate);
                    startGame();
                }
                /*
                else if(code == 97) // 'a' key
                    player.x = Math.max(0, player.x - 5);
                else if(code == 100) // 'd' key
                    player.x = Math.min(100, player.x + 5);
                */
            }

            function endGame(){
                //display game over screen, score, prompt to restart
                ctx.clearRect(0,0, c.width, c.height);
                ctx.beginPath();
                ctx.fillStyle = "#ffffff";
                ctx.strokeStyle = "#000000";
                ctx.fillRect(120, 120, 240, 240);
                ctx.strokeRect(120, 120, 240, 240);
                ctx.fillStyle = "#000000";
                ctx.fillText("GAME OVER", 180, 220);
                ctx.fillText("SCORE: " + score, 190, 270);
                ctx.font = "15px Verdana";
                ctx.fillText("Press 'r' to restart", 174, 320);
                obstacles = [0];
                clearInterval(gameUpdate);
                clearInterval(pipeUpdate);
            }
        </script>
    </body>
</html>