<html>
    <head>
        <title>Flappy Bird Universe v1.1!</title>
        <style>
            button:hover{
                background-color: #2b9AAd;
                color: white;
            }
            canvas{
                border: 2px solid #666666;
            }
        </style>
    </head>
    <body>
        <center>
            <h1>Flappy Bird Universe</h1>
            <button id = "start" onclick="startGame();">Start Game!</button>
            <canvas id="grid" width="480" height="480"></canvas>
            <h4>v1.1</h4>
        </center>
        <script>
            //v1.1: added colors, foreground and background, 
            //      created separate top and bottom pipes
            //      added right side collision detection
            
            // Setup game graphic objects
            var c = document.getElementById("grid");
            var ctx = c.getContext('2d');
            var player = {"x":50, "y":0, "size":10, "v":0};
            var gapConst = player.size * 10;
            var fgHeight = 40;
            var pipeWidth = 25;
            var btwnPipes = 0;
            var topPipes = [];
            var btmPipes = [];
            var obstacles = [];
            var gameUpdate;
            var pipeUpdate;
            var score = 0;
            c.style.display = "none"; //Makes Game Map invisible

            function startGame(){
                player.x = 50;
                player.y = 0;
                player.size = 10;
                player.v = 0;
                btwnPipes = 0;
                topPipes = [0];
                btmPipes = [0];
                obstacles = [0];
                score = 0;
                window.addEventListener('keypress',keyHandler);
                gameUpdate = setInterval(update, 8);
                pipeUpdate = setInterval(spawnPipe, 2500);
                c.style.display = "block";
                var s = document.getElementById("start");
                s.style.display = "none";
            }

            //Update the game frame
            function update(){
                ctx.clearRect(0,0, c.width, c.height);
                background();
                foreground();
                gravity();
                if (drawEntities())
                    endGame();
            }

            function foreground(){
                ctx.fillStyle = "#ac7339";
                ctx.fillRect(0, c.height - fgHeight, c.width, fgHeight);
            }

            function background(){
                var gradientBG = ctx.createLinearGradient(0, 0, 0, c.height - fgHeight);
                gradientBG.addColorStop(0, "white");
                gradientBG.addColorStop(1, "turquoise");
                ctx.fillStyle = gradientBG;
                ctx.fillRect(0,0, c.width, c.height);
            }

            function gravity(){
                player.v += 0.02;
                player.y = Math.min(c.height - 10, Math.max(0, player.y + player.v));
            }

            function spawnPipe(){
                btwnPipes = Math.floor(Math.random() * (c.height - fgHeight - 2 * gapConst) + 0.5*gapConst);
                topPipes.push({ "topEnd": btwnPipes, "x": c.width});
                btmPipes.push({ "btmStart": btwnPipes + gapConst, "x": c.width});
            }

            function drawPlayer(){
                ctx.fillStyle = "#ffff1a";
                ctx.fillRect(player.x, player.y, player.size, player.size);
                ctx.strokeStyle = "#000000";
                ctx.strokeRect(player.x, player.y, player.size, player.size);
            }

            function drawEntities(){
                var crash = false;
                for(i = 0; i < topPipes.length; i++){
                    topPipes[i].x -= 1;
                    btmPipes[i].x -= 1;
                    ctx.fillStyle = "#00b359";
                    ctx.fillRect(topPipes[i].x, 0, pipeWidth, topPipes[i].topEnd); //top pipe
                    ctx.fillRect(btmPipes[i].x, btmPipes[i].btmStart, pipeWidth, c.height - btmPipes[i].btmStart - fgHeight); //bottom pipe
                    if( (player.x + player.size == topPipes[i].x 
                            && (player.y <= topPipes[i].topEnd || player.y + player.size >= btmPipes[i].btmStart)) //hit left side
                        || ((player.x >= topPipes[i].x && player.x + player.size <= topPipes[i].x + pipeWidth) 
                            && (player.y <= topPipes[i].topEnd || player.y + player.size >= btmPipes[i].btmStart)) //hit inside
                        || ((player.x <= topPipes[i].x + pipeWidth && player.x + player.size >= topPipes[i].x + pipeWidth)
                            && (player.y <= topPipes[i].topEnd || player.y + player.size >= btmPipes[i].btmStart)) //hit right side
                        || (player.y + player.size >= c.height - fgHeight)){ //hit ground
                        crash = true;
                        break;
                    }
                    if (topPipes[i].x == player.x)
                        score++; //update score
                    }
                ctx.fillStyle = "#000";
                ctx.font = "20px Verdana";
                ctx.fillText("Score : "+score, 10, 20); //show score
                drawPlayer();
                return crash;
            }

            function keyHandler(e){
                var code = e.keyCode;
                if(code == 32) //space key, make bird fly/jump
                    player.v = -1.3;
                if(code == 114){ // 'r' key, restart the game
                    clearInterval(gameUpdate);
                    clearInterval(pipeUpdate);
                    startGame();
                }
            }

            function endGame(){ //display game over screen, score, prompt to restart
                ctx.clearRect(0,0, c.width, c.height);
                background();
                ctx.fillStyle = "#ffffff";
                ctx.strokeStyle = "#000000";
                ctx.fillRect(120, 120, 240, 240);
                ctx.strokeRect(120, 120, 240, 240);
                ctx.fillStyle = "#000000";
                ctx.fillText("GAME OVER", 180, 220);
                ctx.fillText("SCORE: " + score, 190, 270);
                ctx.font = "15px Verdana";
                ctx.fillText("Press 'r' to restart", 174, 320);
                clearInterval(gameUpdate);
                clearInterval(pipeUpdate);
            }
        </script>
    </body>
</html>